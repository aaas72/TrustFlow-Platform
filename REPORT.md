# التقرير الشامل: الممارسات العامة والتقنية لمنصة العمل الحر (V4)

يقدم هذا التقرير تحليلاً عميقاً لمنصة (V4)، مقسماً إلى قسمين رئيسيين: القسم الأول يتناول الممارسات العامة ومنهجية إدارة النظام، والقسم الثاني يغوص في التفاصيل التقنية الدقيقة، المعمارية البرمجية، والقرارات الهندسية التي تم اتخاذها.

---

## الجزء الأول: الممارسات العامة ومنهجية النظام (General Practices)

يركز هذا الجزء على "منطق العمل" (Business Logic) وكيفية إدارة دورة حياة المشاريع لضمان حقوق جميع الأطراف.

### 1. فلسفة "انعدام الثقة" والضمان المالي (Zero-Trust & Escrow)

تم تصميم النظام بناءً على مبدأ أن الثقة لا تُمنح بل تُبنى تقنياً.

- **الممارسة المتبعة:** استخدام نظام **Escrow (الضمان)** كوسيط إلزامي.
- **التطبيق:** لا يمكن للمستقل بدء العمل (تقنياً) قبل أن يقوم العميل بدفع المال للمنصة. ولا يمكن للمنصة تسليم المال للمستقل إلا بعد موافقة العميل.
- **الهدف:** حماية المستقل من العمل المجاني، وحماية العميل من الدفع مقابل عمل غير مكتمل.
- **الدفتر المحاسبي (Ledger):** يتم تسجيل كل حركة مالية في جدول `transactions` لضمان الشفافية والقدرة على التدقيق المالي.

### 2. دورة حياة المشروع القائمة على المراحل (Milestone-Based Lifecycle)

بدلاً من التعامل مع المشروع ككتلة واحدة، تم اعتماد ممارسة تجزئة العمل.

- **التخطيط (Planning Phase):** بعد قبول العرض، يتم تجميد المشروع حتى يتم إنشاء "خطة عمل" تتكون من مراحل. يتم تخزين هذه الخطة كـ JSON لمرونة التعديل قبل الاعتماد.
- **التنفيذ التتابعي:** لا يمكن الانتقال لمرحلة تالية إلا بإغلاق المرحلة السابقة (مالياً وتقنياً).
- **المرونة:** إمكانية تعديل الخطة طالما لم تبدأ المراحل فعلياً، مع إعادة بناء (Sync) للمراحل غير المكتملة لضمان تطابق الخطة مع الواقع.

### 3. إدارة الملفات المركزية والسيادية

- **الممارسة:** البيانات (بما فيها الملفات المرفقة) هي أصول رقمية يجب أن تكون تحت سيطرة النظام بالكامل.
- **القرار:** الانتقال من تخزين الملفات في المجلدات (File System) إلى تخزينها داخل قاعدة البيانات (Database Storage). هذا يضمن أن النسخة الاحتياطية (Backup) لقاعدة البيانات تحتوي على كل شيء، ويمنع الوصول المباشر للملفات عبر روابط HTTP المباشرة.

---

## الجزء الثاني: الممارسات التقنية والمعمارية (Detailed Technical Practices)

يتناول هذا الجزء "كيف" تم بناء النظام، الأدوات المستخدمة، والأنماط البرمجية (Design Patterns).

### 1. الهيكل المعماري للنظام (System Architecture)

يعتمد النظام معمارية **Client-Server** مفصولة تماماً (Decoupled)، حيث يعمل الواجهة الأمامية (Frontend) والواجهة الخلفية (Backend) كتطبيقات مستقلة تتواصل عبر **RESTful API**.

#### أ. نمط MVC (Model-View-Controller) في الواجهة الخلفية

على الرغم من أنها API، إلا أننا نتبع نمط MVC المعدل:

- **Model (النموذج):** موجود في مجلد `models/` (مثل `User.js`, `Project.js`). يمثل طبقة البيانات ويتعامل مباشرة مع قاعدة البيانات SQL.
- **Controller (المتحكم):** يتمثل في ملفات `routes/` (مثل `projects.js`). تستقبل الطلبات، تعالج المنطق، وتستخدم الـ Models لجلب البيانات.
- **View (العرض):** في حالتنا هو الـ **JSON Response** الذي يعيده الخادم للعميل.

### 2. الخدمات والطبقات (Services & Layers)

تم تقسيم الكود إلى طبقات وخدمات محددة لضمان "فصل المسؤوليات" (Separation of Concerns).

#### خدمات الواجهة الأمامية (Frontend Services)

تقع في مجلد `client/src/services`، وكل ملف مسؤول عن نطاق عمل محدد:

- `authService.ts`: إدارة تسجيل الدخول، التسجيل، وحفظ الـ Token.
- `projectService.ts`: إنشاء المشاريع، جلب القوائم، وتحديث التفاصيل.
- `bidService.ts`: تقديم العروض وقبولها.
- `milestoneService.ts`: إدارة المراحل، تسليم العمل، والموافقة.
- `planService.ts`: إدارة خطط المشاريع وتعديلها.
- `paymentService.ts`: معالجة المدفوعات والشحن.
- `notificationService.ts`: جلب الإشعارات وإدارتها.
- `socketService.ts`: إدارة الاتصال اللحظي (Real-time).
- `api.ts`: إعدادات `axios` الأساسية (Base Configuration).

#### الوسيطات البرمجية (Middleware) في الواجهة الخلفية

تقع في مجلد `server/middleware` وتستخدم في `app.js` لمعالجة الطلبات قبل وصولها للمتحكم:

1.  **Auth Middleware (`requireAuth`):** يتحقق من وجود وصحة الـ JWT Token في الترويسة، ويقوم بفك تشفيره لمعرفة هوية المستخدم.
2.  **Error Handler (`globalErrorHandler`):** وسيط مركزي لالتقاط أي خطأ يحدث في النظام وإرجاع رسالة موحدة للعميل، مما يمنع توقف الخادم.
3.  **Logger (`requestLogger`):** يسجل تفاصيل كل طلب (URL, Method, Time) لأغراض المراقبة.
4.  **CORS Handler:** يسمح للواجهة الأمامية بالوصول للموارد من نطاق مختلف.
5.  **Cache Control:** يمنع المتصفح من تخزين استجابات الـ API لضمان حصول المستخدم دائماً على أحدث البيانات.
6.  **Request ID:** يولد معرفاً فريداً لكل طلب لتسهيل تتبع المشاكل في السجلات (Logs).

### 3. الواجهة الأمامية (Frontend Implementation)

تم بناء الواجهة باستخدام **React.js** مع **TypeScript** و **Vite**.

- **إدارة الحالة (State Management):**
  - استخدام **React Hooks** (`useState`, `useEffect`) للبيانات المحلية.
  - استخدام **Context API** للبيانات العامة (`AuthContext` للمستخدم، `ToastContext` للتنبيهات).
- **التصميم (Styling):**
  - استخدام **Tailwind CSS** لبناء واجهات سريعة وتفاعلية.

### 4. الواجهة الخلفية (Backend Implementation)

النظام مبني على بيئة **Node.js** وإطار عمل **Express**.

- **التعامل مع قاعدة البيانات:**
  - استخدام مكتبة `mysql2` مع **Promises** (`async/await`).
  - استخدام **Parameterized Queries** (?) للحماية من SQL Injection.
- **التواصل اللحظي:**
  - استخدام **Socket.io** لإرسال التنبيهات وتحديثات الحالة فورياً (Observer Pattern).
- **إدارة الملفات:**
  - استخدام `Multer` مع `MemoryStorage` لاستلام الملفات وضخها مباشرة إلى قاعدة البيانات (`LONGBLOB`).

### 5. قاعدة البيانات (Database Schema)

قاعدة بيانات علائقية **MySQL** تحتوي على الجداول الرئيسية:

- `users`, `projects`, `bids`: الكيانات الأساسية.
- `project_plans`, `milestones`: تفاصيل تنفيذ المشروع.
- `payments`, `transactions`: النظام المالي.
- العلاقات محمية بـ **Foreign Keys** لضمان تكامل البيانات.

---

## الخاتمة

منصة (V4) هي نظام متكامل يجمع بين **الأمان المالي** (عبر الـ Escrow)، **المرونة الإدارية** (عبر نظام المراحل والخطط)، و**المتانة التقنية** (عبر معمارية MVC مفصولة وخدمات محددة).
